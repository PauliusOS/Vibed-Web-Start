{
  "_creationTime": 1760315503625.8223,
  "_id": "kn7bxyp0btvh1rz1a3zm219aa97scgqs",
  "authorEmail": "0xpaulius@gmail.com",
  "authorName": "Paulius",
  "categories": [
    "AI"
  ],
  "clerkId": "user_30mlLem6xz7dBn7sqJNMUozNjBR",
  "createdAt": 1760315503629.0,
  "databases": [
    "Convex"
  ],
  "description": "GPT image analysis into your app",
  "frameworks": [
    "Expo"
  ],
  "instructions": "---\nname: agent-gpt-image-implementor\ndescription: when implementing gpt image analysis into the app\nmodel: inherit\ncolor: purple\n---\n\n# Agent: GPT Image Analysis Implementation\n\nThis agent instruction file contains all the essential knowledge and steps needed to implement AI-powered image analysis features in a Convex + Expo React Native app with Clerk authentication. It captures the learnings from our implementation to avoid common pitfalls.\n\n## Agent Overview\n\n**Purpose**: Implement a complete image analysis feature that allows users to upload/capture photos and automatically generate todo items using OpenAI's GPT-4 Vision model.\n\n**Tech Stack**: \n- Backend: Convex (database, actions, HTTP endpoints)\n- AI: OpenAI GPT-4 Vision via Vercel AI SDK\n- Frontend: Expo React Native with Clerk authentication\n- Image handling: Expo ImagePicker + Convex storage\n\n## Critical Implementation Knowledge\n\n### 1. Convex HTTP Actions - URL Gotcha \ud83d\udea8\n\n**CRITICAL**: Convex HTTP actions are served from `.convex.site` NOT `.convex.cloud`\n\n```typescript\n// \u274c WRONG - Will cause 404 errors\nconst uploadUrl = `https://deployment-name.convex.cloud/uploadImage`;\n\n// \u2705 CORRECT - HTTP actions endpoint\nconst uploadUrl = `https://deployment-name.convex.site/uploadImage`;\n```\n\n**Implementation Pattern:**\n```typescript\n// In frontend hooks/components\nconst convexUrl = process.env.EXPO_PUBLIC_CONVEX_URL; // ends with .convex.cloud\nconst siteUrl = convexUrl.replace('.convex.cloud', '.convex.site');\nconst uploadUrl = `${siteUrl}/uploadImage`;\n```\n\n### 2. OpenAI Response Parsing - JSON in Markdown \ud83d\udea8\n\n**CRITICAL**: OpenAI often returns JSON wrapped in markdown code blocks, causing parsing failures.\n\n```javascript\n// \u274c WRONG - Will fail if AI returns ```json ... ```\nconst parsed = JSON.parse(result.text);\n\n// \u2705 CORRECT - Extract JSON from markdown first\nlet content = result.text;\nconst codeBlockMatch = content.match(/```(?:json)?\\s*\\n?([\\s\\S]*?)\\n?```/);\nif (codeBlockMatch) {\n  content = codeBlockMatch[1].trim();\n}\nconst parsed = JSON.parse(content);\n```\n\n### 3. Expo ImagePicker API Updates \ud83d\udea8\n\n**CRITICAL**: Use array of strings for media types, not deprecated enum values\n\n```typescript\n// \u274c DEPRECATED - Will show warnings\nmediaTypes: ExpoImagePicker.MediaTypeOptions.Images,\n// \u274c ALSO DEPRECATED - Still triggers warnings\nmediaTypes: ExpoImagePicker.MediaType.Images,\n\n// \u2705 CURRENT - Use array of strings\nmediaTypes: ['images'],                    // Images only\nmediaTypes: ['videos'],                    // Videos only  \nmediaTypes: ['images', 'videos'],          // Both images and videos\n```\n\n### 4. Clerk Authentication in HTTP Actions \ud83d\udea8\n\n**CRITICAL**: HTTP actions require proper JWT authentication setup\n\n```typescript\n// Frontend: Get proper Clerk token\nconst token = await getToken({ template: \"convex\" });\n\n// HTTP Action: Validate JWT\nconst identity = await ctx.auth.getUserIdentity();\nif (!identity) {\n  return new Response(\"Unauthorized\", { status: 401 });\n}\n```\n\n## Complete Implementation Steps\n\n### Step 1: Install Dependencies\n\n```bash\nnpm install @ai-sdk/openai ai expo-image-picker expo-file-system\n```\n\n### Step 2: Environment Configuration\n\n```env\n# .env.local\nOPENAI_API_KEY=sk-...\nEXPO_PUBLIC_CONVEX_URL=https://deployment-name.convex.cloud\n```\n\n### Step 3: Database Schema Updates\n\n```typescript\n// convex/schema.ts\nimport { defineSchema, defineTable } from \"convex/server\";\nimport { v } from \"convex/values\";\n\nexport default defineSchema({\n  todos: defineTable({\n    text: v.string(),\n    completed: v.boolean(),\n    userId: v.string(),\n    createdAt: v.number(),\n    // New fields for image-generated todos\n    sourceImageId: v.optional(v.id(\"_storage\")),\n    generatedFrom: v.optional(v.literal(\"image\")),\n    confidence: v.optional(v.number()),\n  }),\n\n  imageAnalysis: defineTable({\n    userId: v.string(),\n    storageId: v.id(\"_storage\"),\n    imageUrl: v.string(),\n    prompt: v.string(),\n    analysis: v.string(),\n    todosGenerated: v.array(v.id(\"todos\")),\n    createdAt: v.number(),\n    model: v.string(),\n    tokensUsed: v.optional(v.number()),\n  }),\n});\n```\n\n### Step 4: HTTP Upload Endpoint\n\n```typescript\n// convex/http.ts\nimport { httpRouter } from \"convex/server\";\nimport { httpAction } from \"./_generated/server\";\n\nconst http = httpRouter();\n\nhttp.route({\n  path: \"/uploadImage\",\n  method: \"POST\",\n  handler: httpAction(async (ctx, request) => {\n    const authHeader = request.headers.get(\"Authorization\");\n    if (!authHeader || !authHeader.startsWith(\"Bearer \")) {\n      return new Response(\"Unauthorized\", { status: 401 });\n    }\n\n    try {\n      // Validate JWT token\n      const identity = await ctx.auth.getUserIdentity();\n      if (!identity) {\n        return new Response(\"Unauthorized\", { status: 401 });\n      }\n\n      const blob = await request.blob();\n      const storageId = await ctx.storage.store(blob);\n      \n      return new Response(JSON.stringify({ storageId }), {\n        status: 200,\n        headers: {\n          \"Content-Type\": \"application/json\",\n          \"Access-Control-Allow-Origin\": \"*\",\n          \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n        },\n      });\n    } catch (error) {\n      console.error(\"Upload error:\", error);\n      return new Response(\"Upload failed\", { status: 500 });\n    }\n  }),\n});\n\n// CORS preflight\nhttp.route({\n  path: \"/uploadImage\",\n  method: \"OPTIONS\",\n  handler: httpAction(async () => {\n    return new Response(null, {\n      status: 204,\n      headers: {\n        \"Access-Control-Allow-Origin\": \"*\",\n        \"Access-Control-Allow-Methods\": \"POST, OPTIONS\",\n        \"Access-Control-Allow-Headers\": \"Content-Type, Authorization\",\n      },\n    });\n  }),\n});\n\nexport default http;\n```\n\n### Step 5: OpenAI Integration (Robust Parsing)\n\n```typescript\n// convex/ai/openai.ts\nimport { openai } from '@ai-sdk/openai';\nimport { generateText } from 'ai';\n\nexport interface TodoItem {\n  text: string;\n  confidence: number;\n  category?: string;\n  priority?: 'low' | 'medium' | 'high';\n}\n\nexport interface AIAnalysisResponse {\n  todos: TodoItem[];\n  summary: string;\n  imageDescription: string;\n}\n\nexport const ANALYSIS_PROMPTS = {\n  default: `Analyze this image and extract actionable todo items. \n    Return ONLY a valid JSON object (no markdown, no code blocks, no extra text).\n    Use this exact structure:\n    {\n      \"todos\": [{\"text\": \"task description\", \"confidence\": 0.9, \"category\": \"optional\", \"priority\": \"medium\"}],\n      \"summary\": \"brief summary\",\n      \"imageDescription\": \"description of image\"\n    }`,\n};\n\nexport const analyzeImageWithOpenAI = async (\n  imageUrl: string,\n  prompt: string = ANALYSIS_PROMPTS.default\n): Promise<AIAnalysisResponse> => {\n  const apiKey = process.env.OPENAI_API_KEY;\n  \n  if (!apiKey) {\n    throw new Error('OPENAI_API_KEY is not configured');\n  }\n\n  try {\n    const result = await generateText({\n      model: openai('gpt-4o'),\n      messages: [{\n        role: 'user',\n        content: [\n          { type: 'text', text: prompt },\n          { type: 'image', image: imageUrl }\n        ]\n      }],\n      maxTokens: 1000,\n      temperature: 0.7,\n    });\n\n    let content = result.text;\n    \n    // CRITICAL: Extract JSON from markdown code blocks if present\n    const codeBlockMatch = content.match(/```(?:json)?\\s*\\n?([\\s\\S]*?)\\n?```/);\n    if (codeBlockMatch) {\n      content = codeBlockMatch[1].trim();\n    }\n    \n    try {\n      const parsed = JSON.parse(content);\n      \n      return {\n        todos: parsed.todos || [],\n        summary: parsed.summary || 'Image analyzed successfully',\n        imageDescription: parsed.imageDescription || 'No description available',\n      };\n    } catch (parseError) {\n      console.error('Failed to parse AI response:', content);\n      \n      // Fallback response\n      return {\n        todos: [{\n          text: content || 'Review the uploaded image',\n          confidence: 0.5,\n        }],\n        summary: 'Image processed with basic extraction',\n        imageDescription: 'Image content extracted as text',\n      };\n    }\n  } catch (error) {\n    console.error('OpenAI API error:', error);\n    throw new Error(`Failed to analyze image: ${error instanceof Error ? error.message : 'Unknown error'}`);\n  }\n};\n```\n\n### Step 6: Image Analysis Action\n\n```typescript\n// convex/imageAnalysis.ts\nimport { v } from \"convex/values\";\nimport { action, internalMutation } from \"./_generated/server\";\nimport { internal } from \"./_generated/api\";\nimport { analyzeImageWithOpenAI, ANALYSIS_PROMPTS } from \"./ai/openai\";\n\nexport const analyzeImage = action({\n  args: {\n    storageId: v.id(\"_storage\"),\n    userId: v.string(),\n    promptType: v.optional(v.union(\n      v.literal(\"default\"),\n      v.literal(\"shopping\"),\n      v.literal(\"notes\"),\n      v.literal(\"receipt\")\n    )),\n  },\n  handler: async (ctx, args) => {\n    try {\n      const imageUrl = await ctx.storage.getUrl(args.storageId);\n      \n      if (!imageUrl) {\n        throw new Error(\"Failed to get image URL from storage\");\n      }\n\n      const promptType = args.promptType || \"default\";\n      const prompt = ANALYSIS_PROMPTS[promptType];\n\n      const analysisResult = await analyzeImageWithOpenAI(imageUrl, prompt);\n\n      // Save analysis\n      const analysisId = await ctx.runMutation(internal.imageAnalysis.saveAnalysis, {\n        userId: args.userId,\n        storageId: args.storageId,\n        imageUrl: imageUrl,\n        prompt: prompt,\n        analysis: JSON.stringify(analysisResult),\n        model: \"gpt-4o\",\n      });\n\n      // Save todos\n      const todoIds = await ctx.runMutation(internal.imageAnalysis.saveTodosFromImage, {\n        userId: args.userId,\n        todos: analysisResult.todos.map(todo => ({\n          text: todo.text,\n          confidence: todo.confidence || 0.8,\n        })),\n        sourceImageId: args.storageId,\n        analysisId: analysisId,\n      });\n\n      return {\n        success: true,\n        analysisResult,\n        todoIds,\n        analysisId,\n      };\n    } catch (error) {\n      console.error(\"Image analysis failed:\", error);\n      return {\n        success: false,\n        error: error instanceof Error ? error.message : \"Unknown error occurred\",\n      };\n    }\n  },\n});\n\nexport const saveAnalysis = internalMutation({\n  args: {\n    userId: v.string(),\n    storageId: v.id(\"_storage\"),\n    imageUrl: v.string(),\n    prompt: v.string(),\n    analysis: v.string(),\n    model: v.string(),\n  },\n  handler: async (ctx, args) => {\n    return await ctx.db.insert(\"imageAnalysis\", {\n      userId: args.userId,\n      storageId: args.storageId,\n      imageUrl: args.imageUrl,\n      prompt: args.prompt,\n      analysis: args.analysis,\n      todosGenerated: [],\n      createdAt: Date.now(),\n      model: args.model,\n    });\n  },\n});\n\nexport const saveTodosFromImage = internalMutation({\n  args: {\n    userId: v.string(),\n    todos: v.array(v.object({\n      text: v.string(),\n      confidence: v.number(),\n    })),\n    sourceImageId: v.id(\"_storage\"),\n    analysisId: v.id(\"imageAnalysis\"),\n  },\n  handler: async (ctx, args) => {\n    const todoIds = [];\n    \n    for (const todo of args.todos) {\n      const todoId = await ctx.db.insert(\"todos\", {\n        text: todo.text,\n        completed: false,\n        userId: args.userId,\n        createdAt: Date.now(),\n        sourceImageId: args.sourceImageId,\n        generatedFrom: \"image\" as const,\n        confidence: todo.confidence,\n      });\n      todoIds.push(todoId);\n    }\n    \n    return todoIds;\n  },\n});\n```\n\n### Step 7: Frontend Hook with Correct URLs\n\n```typescript\n// hooks/useImageAnalysis.ts\nimport { useState } from 'react';\nimport { useAction } from 'convex/react';\nimport { api } from '@/convex/_generated/api';\nimport { Platform } from 'react-native';\nimport { useAuth } from '@clerk/clerk-expo';\n\nexport function useImageAnalysis() {\n  const { getToken } = useAuth();\n  const [isAnalyzing, setIsAnalyzing] = useState(false);\n  \n  const analyzeImageAction = useAction(api.imageAnalysis.analyzeImage);\n\n  const uploadImageToConvex = async (imageUri: string): Promise<string | null> => {\n    try {\n      const convexUrl = process.env.EXPO_PUBLIC_CONVEX_URL;\n      if (!convexUrl) {\n        throw new Error('Convex URL not configured');\n      }\n\n      // CRITICAL: Convert from .convex.cloud to .convex.site for HTTP actions\n      const siteUrl = convexUrl.replace('.convex.cloud', '.convex.site');\n\n      let blob: Blob;\n\n      if (Platform.OS === 'web') {\n        const response = await fetch(imageUri);\n        blob = await response.blob();\n      } else {\n        const FileSystem = await import('expo-file-system');\n        const base64 = await FileSystem.readAsStringAsync(imageUri, {\n          encoding: FileSystem.EncodingType.Base64,\n        });\n        blob = await fetch(`data:image/jpeg;base64,${base64}`).then(r => r.blob());\n      }\n\n      const uploadUrl = `${siteUrl}/uploadImage`;\n      const token = await getToken({ template: \"convex\" });\n      \n      const response = await fetch(uploadUrl, {\n        method: 'POST',\n        body: blob,\n        headers: {\n          'Authorization': `Bearer ${token}`,\n        },\n      });\n\n      if (!response.ok) {\n        throw new Error(`Upload failed: ${response.statusText}`);\n      }\n\n      const { storageId } = await response.json();\n      return storageId;\n    } catch (error) {\n      console.error('Upload error:', error);\n      throw error;\n    }\n  };\n\n  const uploadAndAnalyzeImage = async (imageUri: string, userId: string) => {\n    setIsAnalyzing(true);\n    \n    try {\n      const storageId = await uploadImageToConvex(imageUri);\n      \n      if (!storageId) {\n        throw new Error('Failed to upload image');\n      }\n      \n      const result = await analyzeImageAction({\n        storageId: storageId as any,\n        userId,\n      });\n      \n      if (result.success && result.analysisResult) {\n        return result.analysisResult;\n      } else {\n        throw new Error(result.error || 'Analysis failed');\n      }\n    } catch (error) {\n      console.error('Analysis error:', error);\n      throw error;\n    } finally {\n      setIsAnalyzing(false);\n    }\n  };\n\n  return {\n    isAnalyzing,\n    uploadAndAnalyzeImage,\n  };\n}\n```\n\n### Step 8: ImagePicker Component (Current API)\n\n```typescript\n// components/ImagePicker.tsx\nimport React from 'react';\nimport { TouchableOpacity, Text } from 'react-native';\nimport * as ExpoImagePicker from 'expo-image-picker';\n\nexport function ImagePicker({ onImageSelected }: { onImageSelected: (uri: string) => void }) {\n  const pickImageFromLibrary = async () => {\n    try {\n      const result = await ExpoImagePicker.launchImageLibraryAsync({\n        mediaTypes: ['images'], // CRITICAL: Use array of strings, not enum values\n        allowsEditing: true,\n        aspect: [4, 3],\n        quality: 0.8,\n      });\n\n      if (!result.canceled && result.assets && result.assets[0]) {\n        onImageSelected(result.assets[0].uri);\n      }\n    } catch (error) {\n      console.error('Image picker error:', error);\n    }\n  };\n\n  return (\n    <TouchableOpacity onPress={pickImageFromLibrary}>\n      <Text>Choose from Library</Text>\n    </TouchableOpacity>\n  );\n}\n```\n\n## Testing & Debugging Checklist\n\n### \u2705 Deployment Verification\n- [ ] Run `npx convex dev --once` after changes\n- [ ] Check function spec: `npx convex function-spec` should show HTTP routes\n- [ ] Test HTTP endpoint: `curl https://deployment-name.convex.site/test`\n\n### \u2705 Authentication Check\n- [ ] Verify JWT token generation with `getToken({ template: \"convex\" })`\n- [ ] Confirm `ctx.auth.getUserIdentity()` returns user in HTTP action\n- [ ] Check Authorization header format: `Bearer <token>`\n\n### \u2705 AI Response Validation\n- [ ] Log raw AI response to debug parsing issues\n- [ ] Test with simple images first (text, handwriting)\n- [ ] Verify JSON structure matches interface\n\n### \u2705 Common Error Patterns\n- 404 on HTTP endpoints \u2192 Check `.convex.site` vs `.convex.cloud`\n- JSON parse errors \u2192 Check for markdown code block wrapping\n- Auth errors \u2192 Verify JWT token and Clerk configuration\n- Image upload failures \u2192 Check blob conversion and CORS headers\n\n## Environment Variables Template\n\n```env\n# Required\nOPENAI_API_KEY=sk-proj-...\nEXPO_PUBLIC_CONVEX_URL=https://deployment-name.convex.cloud\nCLERK_JWT_ISSUER_DOMAIN=https://clerk-domain.clerk.accounts.dev\n\n# Convex deployment (auto-generated)\nCONVEX_DEPLOYMENT=dev:deployment-name\n```\n\n## Success Metrics & Validation\n\nAfter implementation, verify:\n1. \u2705 Image upload completes without 404 errors\n2. \u2705 AI analysis returns structured todo items\n3. \u2705 Todos are saved to database with proper metadata\n4. \u2705 No deprecation warnings in console\n5. \u2705 Authentication works properly across all endpoints\n\nThis agent instruction captures all critical learnings and should prevent the common pitfalls we encountered during implementation.\n",
  "isPublic": true,
  "logoStorageId": "kg20wyfacc7aygt47jak5cvphx7t4s4r",
  "logoUrl": "https://tacit-capybara-732.convex.cloud/api/storage/4015d1f9-0464-4338-bcf5-549872dc54be",
  "mcpServers": [],
  "name": "GPT Image-Analysis",
  "popularity": 7.0,
  "tags": [
    "ai image analysis",
    "ai"
  ],
  "updatedAt": 1761386508583.0,
  "usageCount": 10.0,
  "userId": "user_30mlLem6xz7dBn7sqJNMUozNjBR"
}