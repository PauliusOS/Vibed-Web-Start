{
  "_creationTime": 1760359423232.1873,
  "_id": "kn78tt05y0kh45srpyz2r87zf17scyhr",
  "authorEmail": "0xpaulius@gmail.com",
  "authorName": "Paulius",
  "categories": [],
  "clerkId": "user_30mlLem6xz7dBn7sqJNMUozNjBR",
  "createdAt": 1760359423236.0,
  "databases": [
    "Convex"
  ],
  "description": "Best practices when coding clerk auth with convex+expo framework",
  "frameworks": [
    "Expo"
  ],
  "instructions": "---\nname: agent-clerk-auth-with-expo-convex\ndescription: Best practices for Clerk authentication in Expo + Convex with proper token caching, protected routes, and real-time sync\nmodel: inherit\ncolor: purple\n---\n\n# Agent: Clerk Authentication for Expo + Convex\n\nBest practices for implementing Clerk authentication in Expo React Native apps with Convex backend. Covers token caching, protected routes, OAuth integration, and real-time user authentication.\n\n## =4 CRITICAL: SecureStore Token Cache\n\n### Issue: Token Persistence and Security\nWithout proper token caching, users get signed out on app restarts and authentication fails silently.\n\n**ERROR:** Authentication state lost on app reload, infinite authentication loops, or secure token storage failures\n\n### Solution: Always Use SecureStore Token Cache\n\n```typescript\n// \u274c FAILS - No token cache\n<ClerkProvider publishableKey={publishableKey}>\n  <App />\n</ClerkProvider>\n\n// \u2705 WORKS - Proper SecureStore token cache\nimport * as SecureStore from \"expo-secure-store\";\n\nconst tokenCache = {\n  async getToken(key: string) {\n    try {\n      return await SecureStore.getItemAsync(key);\n    } catch (error) {\n      console.error(\"SecureStore getToken error:\", error);\n      return null;\n    }\n  },\n  async saveToken(key: string, value: string) {\n    try {\n      await SecureStore.setItemAsync(key, value);\n    } catch (error) {\n      console.error(\"SecureStore saveToken error:\", error);\n    }\n  },\n  async deleteToken(key: string) {\n    try {\n      await SecureStore.deleteItemAsync(key);\n    } catch (error) {\n      console.error(\"SecureStore deleteToken error:\", error);\n    }\n  },\n};\n\n// Basic setup - works with any app structure\n<ClerkProvider tokenCache={tokenCache} publishableKey={publishableKey}>\n  <ClerkLoaded>\n    <YourAppContent />\n  </ClerkLoaded>\n</ClerkProvider>\n```\n\n## =4 CRITICAL: Protected Routes with Automatic Redirects\n\n### Issue: Unprotected Routes and Manual Navigation\nWithout proper route protection, users can access authenticated content while signed out.\n\n### Solution: useAuth Hook with Automatic Redirects\n\n```typescript\n// \u274c FAILS - No authentication check\nexport default function ProtectedScreen() {\n  return (\n    <View>\n      <Text>Protected content anyone can see</Text>\n    </View>\n  );\n}\n\n// \u2705 WORKS - Protected with automatic redirect (Expo Router)\nimport { Redirect } from 'expo-router';\nimport { useAuth } from '@clerk/clerk-expo';\n\nexport default function ProtectedScreen() {\n  const { isSignedIn, isLoaded } = useAuth();\n\n  if (!isLoaded) {\n    return <LoadingSpinner />; // or return null\n  }\n\n  if (!isSignedIn) {\n    return <Redirect href=\"/sign-in\" />; // Adjust path to your auth screen\n  }\n\n  return (\n    <View>\n      <Text>Protected content</Text>\n    </View>\n  );\n}\n\n// \u2705 ALTERNATIVE - For React Navigation\nimport { useAuth } from '@clerk/clerk-expo';\n\nfunction AppNavigator() {\n  const { isSignedIn, isLoaded } = useAuth();\n\n  if (!isLoaded) return <LoadingScreen />;\n\n  return (\n    <NavigationContainer>\n      <Stack.Navigator>\n        {isSignedIn ? (\n          <Stack.Screen name=\"Main\" component={MainTabs} />\n        ) : (\n          <Stack.Screen name=\"Auth\" component={AuthStack} />\n        )}\n      </Stack.Navigator>\n    </NavigationContainer>\n  );\n}\n```\n\n## =4 CRITICAL: Environment Variable Validation\n\n### Issue: Runtime Crashes from Missing Configuration\nMissing publishable keys cause runtime crashes instead of helpful error messages.\n\n### Solution: Always Validate Configuration\n\n```typescript\n// \u274c FAILS - No validation, cryptic runtime errors\nfunction App() {\n  const publishableKey = process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY;\n\n  return (\n    <ClerkProvider publishableKey={publishableKey}>\n      <YourApp />\n    </ClerkProvider>\n  );\n}\n\n// \u2705 WORKS - Validation with helpful error message\nfunction App() {\n  const publishableKey = process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY;\n\n  if (!publishableKey) {\n    return (\n      <View style={{ flex: 1, justifyContent: 'center', alignItems: 'center', padding: 20 }}>\n        <Text style={{ fontSize: 18, fontWeight: 'bold', marginBottom: 10 }}>\n          Clerk Setup Required\n        </Text>\n        <Text style={{ textAlign: 'center', marginBottom: 10 }}>\n          Missing EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY\n        </Text>\n        <Text style={{ textAlign: 'center', fontSize: 12, color: '#666' }}>\n          1. Get your publishable key from Clerk Dashboard{'\\n'}\n          2. Add to .env.local or .env:{'\\n'}\n          EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_*****\n        </Text>\n      </View>\n    );\n  }\n\n  return (\n    <ClerkProvider tokenCache={tokenCache} publishableKey={publishableKey}>\n      <ClerkLoaded>\n        <YourApp />\n      </ClerkLoaded>\n    </ClerkProvider>\n  );\n}\n```\n\n## =3 IMPORTANT: OAuth Integration with Session Handling\n\n### Issue: Incomplete OAuth Flow\nOAuth flows can fail at session creation or require additional steps for completion.\n\n### Solution: Comprehensive OAuth Handler\n\n```typescript\n// \u274c FAILS - Incomplete OAuth handling\nconst onGoogleSignIn = async () => {\n  const { createdSessionId } = await startOAuthFlow();\n  await setActive({ session: createdSessionId });\n  router.replace(\"/(tabs)\");\n};\n\n// \u2705 WORKS - Complete OAuth flow with fallback handling\nconst onGoogleSignIn = async () => {\n  try {\n    const { createdSessionId, signIn: oAuthSignIn, signUp: oAuthSignUp } = await startOAuthFlow();\n\n    if (createdSessionId) {\n      // Direct session creation - most common case\n      await setActive({ session: createdSessionId });\n      router.replace(\"/(tabs)\");\n    } else {\n      // Handle incomplete flows\n      if (oAuthSignIn && oAuthSignIn.status === \"complete\") {\n        await setActive({ session: oAuthSignIn.createdSessionId });\n        router.replace(\"/(tabs)\");\n      } else if (oAuthSignUp && oAuthSignUp.status === \"complete\") {\n        await setActive({ session: oAuthSignUp.createdSessionId });\n        router.replace(\"/(tabs)\");\n      } else {\n        // Log for debugging incomplete flows\n        console.log(\"OAuth flow incomplete:\", {\n          signIn: oAuthSignIn,\n          signUp: oAuthSignUp\n        });\n      }\n    }\n  } catch (err: any) {\n    console.error(\"OAuth error:\", JSON.stringify(err, null, 2));\n    Alert.alert(\"Error\", \"Authentication failed. Please try again.\");\n  }\n};\n\n// Initialize OAuth provider\nconst { startOAuthFlow } = useOAuth({ strategy: \"oauth_google\" });\n\n// Required for OAuth completion\nimport * as WebBrowser from \"expo-web-browser\";\nWebBrowser.maybeCompleteAuthSession();\n```\n\n## =3 IMPORTANT: User-Friendly Error Handling\n\n### Issue: Generic Error Messages\nDefault Clerk errors are technical and confusing for end users.\n\n### Solution: Specific Error Code Handling\n\n```typescript\n// \u274c FAILS - Generic error handling\ncatch (err: any) {\n  Alert.alert(\"Error\", \"Sign in failed\");\n}\n\n// \u2705 WORKS - Specific error messages\ncatch (err: any) {\n  const errorCode = err.errors?.[0]?.code;\n  let errorMessage = \"Sign in failed\";\n\n  if (errorCode === \"form_identifier_not_found\") {\n    errorMessage = \"No account found with this email. Please check your email or sign up.\";\n  } else if (errorCode === \"form_password_incorrect\") {\n    errorMessage = \"Incorrect password. Please try again.\";\n  } else if (errorCode === \"user_locked\") {\n    errorMessage = \"Account locked. Please try again later.\";\n  } else if (errorCode === \"too_many_requests\") {\n    errorMessage = \"Too many attempts. Please wait before trying again.\";\n  } else if (err.errors?.[0]?.message) {\n    errorMessage = err.errors[0].message;\n  }\n\n  setErrorMessage(errorMessage);\n  Alert.alert(\"Sign In Failed\", errorMessage);\n}\n```\n\n## =3 IMPORTANT: Secure Sign Out with Token Cleanup\n\n### Issue: Incomplete Logout\nFailing to clear cached tokens can cause authentication state issues.\n\n### Solution: Complete Token Cleanup\n\n```typescript\n// \u274c FAILS - Incomplete sign out\nconst handleSignOut = async () => {\n  await signOut();\n};\n\n// \u2705 WORKS - Complete token cleanup\nconst handleSignOut = async () => {\n  try {\n    // Clear cached tokens first\n    await Promise.all([\n      SecureStore.deleteItemAsync(\"__clerk_client_jwt\"),\n      SecureStore.deleteItemAsync(\"__clerk_db_jwt\"),\n      SecureStore.deleteItemAsync(\"__clerk_session_jwt\"),\n    ]);\n\n    // Then sign out from Clerk\n    await signOut();\n  } catch (error) {\n    console.error(\"Sign out error:\", error);\n    Alert.alert(\"Error\", \"Failed to sign out. Please try again.\");\n  }\n};\n\n// Platform-specific confirmation\nconst confirmSignOut = () => {\n  if (Platform.OS === 'web') {\n    const confirmed = window.confirm(\"Are you sure you want to sign out?\");\n    if (confirmed) handleSignOut();\n  } else {\n    Alert.alert(\n      \"Sign Out\",\n      \"Are you sure you want to sign out?\",\n      [\n        { text: \"Cancel\", style: \"cancel\" },\n        { text: \"Sign Out\", style: \"destructive\", onPress: handleSignOut },\n      ]\n    );\n  }\n};\n```\n\n## =2 HELPFUL: Convex Integration Patterns\n\n### Convex Authentication Setup\n```typescript\n// convex/auth.config.ts\nexport default {\n  providers: [\n    {\n      domain: process.env.CLERK_JWT_ISSUER_DOMAIN,\n      applicationID: \"convex\",\n    },\n  ],\n};\n```\n\n### User-Scoped Queries and Mutations\n- Always check `await ctx.auth.getUserIdentity()` in Convex functions\n- Use `identity.subject` as the user ID for data filtering\n- Return empty results (not errors) for unauthenticated users in queries\n- Throw errors for unauthenticated mutation attempts\n\n### ConvexProviderWithClerk Setup\n- Wrap app with `ConvexProviderWithClerk` inside `ClerkLoaded`\n- Pass `useAuth` hook to connect Clerk state with Convex\n- Ensure Convex client is created after environment validation\n\n## =2 HELPFUL: Expo + Convex Setup Template\n\n### Complete Integration Pattern\n```typescript\nimport { ClerkProvider, ClerkLoaded, useAuth } from \"@clerk/clerk-expo\";\nimport { ConvexReactClient } from \"convex/react\";\nimport { ConvexProviderWithClerk } from \"convex/react-clerk\";\nimport * as SecureStore from \"expo-secure-store\";\n\n// Environment validation\nconst convexUrl = process.env.EXPO_PUBLIC_CONVEX_URL;\nconst publishableKey = process.env.EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY;\nconst convex = convexUrl?.startsWith('https://') ? new ConvexReactClient(convexUrl) : null;\n\n// SecureStore token cache\nconst tokenCache = { /* SecureStore implementation */ };\n\nfunction ConvexProviderWithAuth({ children }: { children: React.ReactNode }) {\n  if (!convex) return <SetupErrorScreen type=\"convex\" />;\n\n  return (\n    <ConvexProviderWithClerk client={convex} useAuth={useAuth}>\n      {children}\n    </ConvexProviderWithClerk>\n  );\n}\n\nexport function AuthProvider({ children }: { children: React.ReactNode }) {\n  if (!publishableKey) return <SetupErrorScreen type=\"clerk\" />;\n\n  return (\n    <ClerkProvider tokenCache={tokenCache} publishableKey={publishableKey}>\n      <ClerkLoaded>\n        <ConvexProviderWithAuth>\n          {children}\n        </ConvexProviderWithAuth>\n      </ClerkLoaded>\n    </ClerkProvider>\n  );\n}\n```\n\n## Environment Variables\n\n### Required Configuration\n\n```bash\n# .env.local\nEXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_*****\nEXPO_PUBLIC_CONVEX_URL=https://your-deployment.convex.cloud\n```\n\n### Convex Dashboard Configuration\n**CRITICAL:** Set in Convex Dashboard Environment Variables (NOT in .env):\n```\nCLERK_JWT_ISSUER_DOMAIN=https://your-domain.clerk.accounts.dev\n```\n\n## Package Dependencies\n\n```json\n{\n  \"dependencies\": {\n    \"@clerk/clerk-expo\": \"^2.14.24\",\n    \"expo-secure-store\": \"^13.0.2\",\n    \"expo-web-browser\": \"^13.0.3\",\n    \"convex\": \"^1.16.4\",\n    \"convex/react-clerk\": \"^0.2.36\"\n  }\n}\n```\n\n## Quick Troubleshooting\n\n| Error | Cause | Fix |\n|-------|-------|-----|\n| \"Network request failed\" | Missing publishable key | Add `EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY` |\n| Authentication loops | No token cache | Implement SecureStore token cache |\n| OAuth popup closes immediately | Missing WebBrowser setup | Add `WebBrowser.maybeCompleteAuthSession()` |\n| Users signed out on restart | SecureStore errors | Check SecureStore error handling |\n| \"Invalid token\" in Convex | Wrong JWT issuer domain | Set `CLERK_JWT_ISSUER_DOMAIN` in Convex Dashboard |\n| Convex queries return empty | No user authentication | Check `ctx.auth.getUserIdentity()` in functions |\n| ConvexProviderWithClerk error | Missing useAuth prop | Pass `useAuth` hook to provider |\n| Real-time updates don't work | Provider order wrong | ClerkProvider \u2192 ClerkLoaded \u2192 ConvexProviderWithClerk |\n\n## =1 AUDIT: Implementation Health Check\n\n### Quick Implementation Verification\nUse this checklist to verify your Clerk implementation is following best practices:\n\n```bash\n# 1. Check environment variables\ngrep -r \"EXPO_PUBLIC_CLERK\" . --include=\"*.env*\"\n# Should find: EXPO_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_test_*****\n\n# 2. Check for SecureStore token cache\ngrep -r \"tokenCache.*SecureStore\" . --include=\"*.tsx\" --include=\"*.ts\"\n# Should find token cache implementation\n\n# 3. Check for ClerkLoaded wrapper\ngrep -r \"ClerkLoaded\" . --include=\"*.tsx\" --include=\"*.ts\"\n# Should find ClerkLoaded wrapping your app\n\n# 4. Check for protected routes\ngrep -r \"useAuth.*isSignedIn\" . --include=\"*.tsx\" --include=\"*.ts\"\n# Should find route protection logic\n```\n\n### Authentication State Debugging\nKey debugging points for Clerk auth issues:\n\n- Check `isLoaded` before using any auth state\n- Verify `getToken()` returns a valid JWT when signed in\n- Log auth state changes to identify timing issues\n- Check `user.primaryEmailAddress?.emailAddress` for user data\n\n### Common Implementation Issues\n\n**\u274c Missing Token Cache** - Will lose auth state on app restart\n**\u274c No Loading State Handling** - Check `isLoaded` before rendering auth-dependent UI\n**\u274c Unprotected API Calls** - Always use `getToken()` for authenticated requests\n**\u274c Missing ClerkLoaded** - Wrap app content to prevent auth state flicker\n\n## =1 MAINTENANCE: Ongoing Management\n\n### Monitoring Authentication Health\n\n**Key Metrics to Track:**\n- Token refresh success/failure rates\n- Auth state change frequency and timing\n- SecureStore read/write errors\n- Session expiry patterns\n\n**Health Check Points:**\n- Verify `getToken()` works for signed-in users\n- Test SecureStore read/write functionality\n- Monitor auth state persistence across app restarts\n- Track authentication error frequencies\n\n### User Management with Convex\n\n**User Sync Pattern:**\n- Create/update Convex user records when Clerk user data changes\n- Use Convex mutations to sync `user.id`, `primaryEmailAddress`, `fullName`\n- Handle user deletion from Convex when Clerk account is deleted\n\n**Session Management:**\n- Convex automatically handles JWT token validation and refresh\n- User identity available via `ctx.auth.getUserIdentity()` in all functions\n- No manual session expiry handling needed (Convex + Clerk manages this)\n\n### Performance with Convex\n\n**Optimize Real-time Subscriptions:**\n- Use user-scoped queries to minimize unnecessary data subscriptions\n- Avoid multiple auth hooks in same component - `useAuth()` provides user data\n- Convex optimistic updates work automatically with Clerk authentication\n\n**Efficient Data Patterns:**\n- Filter data at Convex function level using `identity.subject`\n- Use Convex indexes for user-specific data (`by_user` index pattern)\n- Convex handles caching and real-time sync automatically\n\n## Testing Checklist\n\n### Initial Implementation Testing\n- [ ] Test sign-up flow with email verification (if enabled)\n- [ ] Test sign-in with valid/invalid credentials\n- [ ] Test OAuth flow completion (Google, Apple, etc.)\n- [ ] Test protected route redirects when signed out\n- [ ] Test token persistence after app restart\n- [ ] Test sign out with proper token cleanup\n- [ ] Test error handling for network failures\n- [ ] Test backend API calls with JWT tokens\n- [ ] Test platform-specific behaviors (iOS/Android/web)\n- [ ] Check SecureStore permissions and error handling\n- [ ] Verify environment variable validation works\n- [ ] Test authentication state changes in real-time\n\n### Ongoing Health Testing (Convex-Specific)\n- [ ] Verify Convex queries return user-scoped data only\n- [ ] Test real-time updates work for authenticated users\n- [ ] Check `ctx.auth.getUserIdentity()` works in all Convex functions\n- [ ] Monitor Convex function authentication success rates\n- [ ] Test user data sync between Clerk and Convex\n- [ ] Verify `CLERK_JWT_ISSUER_DOMAIN` is correctly configured\n- [ ] Test ConvexProviderWithClerk integration after updates",
  "isPublic": true,
  "logoStorageId": "kg22j34catjasxkx0n6kyz5wx97t47nj",
  "logoUrl": "https://tacit-capybara-732.convex.cloud/api/storage/ed329d45-62a9-4ad5-8832-daa84fd4d1be",
  "mcpServers": [],
  "name": "Clerk (Convex + Expo)",
  "popularity": 7.0,
  "tags": [
    "clerk",
    "clerk auth"
  ],
  "updatedAt": 1761386551831.0,
  "usageCount": 9.0,
  "userId": "user_30mlLem6xz7dBn7sqJNMUozNjBR"
}